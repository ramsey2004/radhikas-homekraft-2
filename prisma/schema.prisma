// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  phone         String?
  role          Role      @default(USER)
  
  // Relations
  accounts      Account[]
  sessions      Session[]
  orders        Order[]
  reviews       Review[]
  addresses     Address[]
  wishlistItems WishlistItem[]
  cart          Cart?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
}

// NextAuth Models
model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Product Models
model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  image       String?
  
  // Relations
  products    Product[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
}

model Product {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  description  String
  shortDescription String?
  price        Float
  maxPrice     Float?   // For Shopify products with price ranges
  discountedPrice Float?
  inventory    Int      @default(0)
  sku          String   @unique
  
  // Shopify integration
  shopifyId    String?  // External Shopify product ID
  shopifyProductHandle String? // Shopify product handle for URLs
  
  // Images
  images       String[] // JSON array of image URLs
  productImages ProductImage[]
  thumbnail    String?
  
  // Category relation
  categoryId   String
  category     Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  
  // Additional details
  material     String?
  color        String?
  dimensions   String? // JSON: {"length": 100, "width": 80, "height": 10}
  weight       Float?
  
  // Variants
  variants     ProductVariant[]
  
  // Relations
  orderItems   OrderItem[]
  reviews      Review[]
  wishlistItems WishlistItem[]
  cartItems    CartItem[]
  
  isFeatured   Boolean  @default(false)
  isActive     Boolean  @default(true)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([categoryId])
  @@index([slug])
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  size      String?
  color     String?
  quantity  Int
  sku       String  @unique
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
}

// Product Images - Detailed image management
model ProductImage {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  url       String
  altText   String?
  caption   String?
  order     Int      @default(0) // Image display order
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
}

// Cart Models
model Cart {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  items     CartItem[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  quantity  Int      @default(1)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
}

// Order Models
model Order {
  id                String   @id @default(cuid())
  orderNumber       String   @unique
  
  // User relation (optional for guest orders)
  userId            String?
  user              User?    @relation(fields: [userId], references: [id], onDelete: Restrict)
  
  // Guest order info
  email             String
  phone             String?
  guestFirstName    String?
  guestLastName     String?
  guestAddress      String?
  
  items             OrderItem[]
  
  subtotal          Float
  tax               Float    @default(0)
  shippingCost      Float    @default(0)
  discountAmount    Float    @default(0)
  total             Float
  
  status            OrderStatus @default(PENDING)
  paymentStatus     PaymentStatus @default(PENDING)
  paymentMethod     PaymentMethod
  
  shippingAddress   Address?  @relation("ShippingAddress", fields: [shippingAddressId], references: [id], onDelete: Restrict)
  shippingAddressId String?
  
  billingAddress    Address?  @relation("BillingAddress", fields: [billingAddressId], references: [id], onDelete: Restrict)
  billingAddressId  String?
  
  notes             String?
  
  // Payment info
  paymentId         String?
  paymentRef        String?
  
  // Shopify integration
  shopifyCheckoutId String? // Shopify checkout ID for tracking
  
  // Discount
  discountCodeId    String?
  discountCode      DiscountCode? @relation(fields: [discountCodeId], references: [id], onDelete: SetNull)
  
  trackingNumber    String?
  estimatedDelivery DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([paymentStatus])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  
  quantity  Int
  price     Float    // Price at purchase time
  
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

// Address Model
model Address {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  firstName     String
  lastName      String
  email         String?
  phone         String
  
  street1       String
  street2       String?
  city          String
  state         String
  postalCode    String
  country       String  @default("India")
  
  isDefault     Boolean @default(false)
  
  // Order relations
  shippingOrders Order[] @relation("ShippingAddress")
  billingOrders  Order[] @relation("BillingAddress")
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
}

// Review Model
model Review {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  rating    Int // 1-5
  comment   String?
  images    String[] // Array of image URLs
  
  verified  Boolean  @default(true) // Verified purchase badge
  helpful   Int      @default(0)
  unhelpful Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, userId])
  @@index([productId])
  @@index([userId])
  @@index([rating])
}

// Wishlist Model
model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

// Discount Code Model
model DiscountCode {
  id          String   @id @default(cuid())
  code        String   @unique
  description String?
  
  discountType DiscountType @default(PERCENTAGE)
  discountValue Float
  maxDiscount   Float? // For percentage discounts
  
  minOrderValue Float? // Minimum cart value to apply
  
  usageLimit  Int?
  usageCount  Int      @default(0)
  
  validFrom   DateTime
  validUntil  DateTime
  
  isActive    Boolean  @default(true)
  
  orders      Order[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
}

// Newsletter Subscription Model
model Newsletter {
  id        String   @id @default(cuid())
  email     String   @unique
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

// Contact Form Model
model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String
  status    MessageStatus @default(NEW)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
}

// Email Log - Track all emails sent
model EmailLog {
  id        String   @id @default(cuid())
  to        String
  subject   String
  template  String   // 'welcome', 'order-confirmation', 'shipment', etc.
  status    EmailStatus @default(PENDING)
  
  sentAt    DateTime?
  failureReason String?
  
  metadata  String?  // JSON: { orderId, userId, etc. }
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([to])
  @@index([status])
  @@index([template])
}

// Payment Log - Track all payment transactions
model PaymentLog {
  id        String   @id @default(cuid())
  orderId   String
  
  paymentMethod PaymentMethod
  paymentGateway String // 'razorpay', 'stripe'
  
  amount    Float
  currency  String   @default("INR")
  
  gatewayTransactionId String?
  gatewayResponse String? // JSON response from gateway
  
  status    PaymentStatus
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([paymentGateway])
}

// Analytics Event - Track user behavior
model AnalyticsEvent {
  id        String   @id @default(cuid())
  userId    String?  // Can be null for anonymous users
  
  eventType EventType
  eventName String
  
  page      String?
  referer   String?
  userAgent String?
  ipAddress String?
  
  productId String?
  category  String?
  
  metadata  String?  // JSON additional data
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@index([productId])
}

// Enums
enum Role {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  RAZORPAY
  STRIPE
  COD // Cash on Delivery
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum MessageStatus {
  NEW
  READ
  REPLIED
  CLOSED
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

enum EventType {
  PAGE_VIEW
  PRODUCT_VIEW
  ADD_TO_CART
  REMOVE_FROM_CART
  WISHLIST_ADD
  WISHLIST_REMOVE
  CHECKOUT_START
  CHECKOUT_COMPLETE
  PURCHASE
  SEARCH
  FILTER
  REVIEW_SUBMIT
  REVIEW_HELPFUL
  CLICK
  SCROLL
}
